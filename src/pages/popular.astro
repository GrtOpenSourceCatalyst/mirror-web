---
import BasicLayout from "../layouts/BasicLayout.astro";
import PopularMirrors from "../components/PopularMirrors.svelte";
import "@/styles/global.css";

const pageTitle = "热门镜像 | 我的镜像站";
const pageDescription = "查看最受欢迎的开源软件镜像，基于下载量和用户喜好排序。";

// 在服务端获取镜像数据
let initialMirrors = [];
let initialError = null;

try {
  const response = await fetch("http://localhost:8082/static/tunasync.json");

  if (!response.ok) {
    throw new Error(`HTTP错误: ${response.status}`);
  }

  const data = await response.json();
  initialMirrors = Object.entries(data).map(([name, info]) => ({
    name,
    ...info,
    // 格式化最后更新时间
    lastUpdated: new Date(info.last_update_ts * 1000).toLocaleString("zh-CN"),
    // 添加模拟的下载量数据（在实际应用中会从真实统计中获取）
    downloads: Math.floor(Math.random() * 10000),
    // 添加模拟的受欢迎度分数
    popularity: Math.floor(Math.random() * 100)
  }));
  
  // 按下载量排序
  initialMirrors.sort((a, b) => b.downloads - a.downloads);
} catch (err) {
  initialError = err.message;
  console.error("服务端获取数据失败:", err);
}
---

<BasicLayout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 py-6">
    <div class="mb-8">
      <h1 class="from-primary-500 to-tertiary-500 bg-gradient-to-r bg-clip-text text-4xl font-bold text-transparent mb-4">
        热门镜像
      </h1>
      <p class="text-lg text-surface-700-200-token">
        这些是用户最常使用的开源软件镜像，根据下载量和使用频率排序
      </p>
    </div>

    <PopularMirrors 
      client:load 
      initialMirrors={initialMirrors} 
      initialError={initialError}
    />
  </div>
</BasicLayout>
